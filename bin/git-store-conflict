#!/bin/bash
usage() {
cat <<EOF
usage: git store-conflict 

    -m     merges the status into OCTOPUS_CONFLICT_STORE.
EOF
}

tmp=$(git rev-parse --git-dir)/OCTOPUS_CONFLICT_STORE

merge=false

while getopts "hm" opt; do
	case "$opt" in
	h)
		usage
		exit 0
	;;
	m)
		merge=true
	;;
	esac
done

if $merge && [ ! -f $tmp ] ; then
	echo "No conflict has been previously recorded" >&2
	exit 1
fi

if ! $merge && [ -f $tmp ] ; then
	echo "You are in the middle of a resolution"
	exit 1
fi

if ! $merge ; then
	if [ -z "$(git ls-files --unmerged)" ] ; then
		echo "No conflicts to store" >&2
		exit 1
	fi
	git hash-conflict > $tmp
else 
	if [ -z "$(git ls-files --unmerged)" ] ; then
		# if all conflicts are resolved ...
		tree=$(git write-tree)
		commit=$(git commit-tree $tree -m "dudu")
		git update-ref "refs/conflicts/$(cat $tmp)" "$commit" ""
		echo "$commit -> refs/conflicts/$(cat $tmp)" 
	else
		echo "All conflict must be resolved"
		exit 1
	fi
fi
